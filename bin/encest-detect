#!/usr/bin/env ruby

require 'json'
require 'slop'
require 'encoding_estimator'

opts = Slop.parse do |o|
  o.array(
      '--encodings', 'Encodings to test', default: %w(utf-8 iso-8859-1 Windows-1251 Windows-1252)
  )
  o.array(
      '--directions', 'Directions (encode/decode) to test',
      default: [EncodingEstimator::Conversion::Directions::ENCODE, EncodingEstimator::Conversion::Directions::DECODE]
  )
  o.array(
      '--languages', 'Language profiles to apply (distributions to use)', default: ['de', 'en']
  )
  o.bool(
      '--help', '-h', 'Display help'
  )
end

if opts[:help]
  puts opts
  puts (' ' * 4) + 'other arguments: files to parse'
  exit! 0
end

opts.arguments.each do |file|
  unless File.file? file
    puts "No such file: #{file}"
    exit! 1
  end
end

opts.arguments.each do |file|
  detection = EncodingEstimator.detect File.read(file ), {
                    languages:  opts[:languages],  encodings: opts[:encodings],
                    directions: opts[:directions], include_default: true
  }

  puts "#{file}: #{detection.result.key}"
  detection.results.each { |r| puts "    #{r[:conversion].key}: #{r[:score]}" }
end
